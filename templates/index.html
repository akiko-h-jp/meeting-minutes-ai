<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­°äº‹éŒ²ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“„ è­°äº‹éŒ²ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="subtitle">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯æ–‡å­—èµ·ã“ã—æ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•ã§è­°äº‹éŒ²ã‚’ç”Ÿæˆã—ã€Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ä¿å­˜ã—ã¾ã™</p>
        </header>

        <main>
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".mp4,.m4a,.wav,.mp3,.flac,.ogg,.webm,.txt,.md" style="display: none;">
                    <label for="fileInput" class="upload-label">
                        <span class="upload-icon">ğŸ“</span>
                        <span class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                    </label>
                    <p class="file-info">å¯¾å¿œå½¢å¼: MP4, M4A, WAV, MP3, FLAC, OGG, WEBM, TXT, MDï¼ˆæ–‡å­—èµ·ã“ã—æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</p>
                </div>
            </div>

            <div class="status-section" id="statusSection" style="display: none;">
                <h2>å‡¦ç†çŠ¶æ³</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-list">
                    <div class="status-item waiting" id="statusTranscription">
                        <span class="status-icon">â³</span>
                        <span class="status-text">æ–‡å­—èµ·ã“ã—å¾…æ©Ÿä¸­...</span>
                    </div>
                    <div class="status-item waiting" id="statusMinutes">
                        <span class="status-icon">â³</span>
                        <span class="status-text">è­°äº‹éŒ²ç”Ÿæˆå¾…æ©Ÿä¸­...</span>
                    </div>
                    <div class="status-item waiting" id="statusDocs">
                        <span class="status-icon">â³</span>
                        <span class="status-text">Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿å­˜å¾…æ©Ÿä¸­...</span>
                    </div>
                    <div class="status-item waiting" id="statusSlack">
                        <span class="status-icon">â³</span>
                        <span class="status-text">Slacké€šçŸ¥å¾…æ©Ÿä¸­...</span>
                    </div>
                </div>
            </div>

            <div class="results-section" id="resultsSection" style="display: none;">
                <h2>å‡¦ç†çµæœ</h2>
                <div class="result-item">
                    <h3>ç”Ÿæˆã•ã‚ŒãŸè­°äº‹éŒ²</h3>
                    <div class="minutes-preview" id="minutesPreview"></div>
                </div>
                <div class="result-item">
                    <h3>Slacké€šçŸ¥å†…å®¹</h3>
                    <div class="slack-message" id="slackMessage"></div>
                </div>
                <div class="result-actions">
                    <a href="#" id="downloadLink" class="btn btn-primary">è­°äº‹éŒ²ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                    <a href="#" id="docLink" target="_blank" class="btn btn-secondary">Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ã</a>
                </div>
            </div>
        </main>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const statusSection = document.getElementById('statusSection');
        const resultsSection = document.getElementById('resultsSection');
        let currentSessionId = null;
        let statusInterval = null;

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.error) {
                    alert(data.error);
                    return;
                }

                currentSessionId = data.session_id;
                statusSection.style.display = 'block';
                resultsSection.style.display = 'none';
                startStatusPolling();
            } catch (error) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        });

        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(async () => {
                if (!currentSessionId) return;

                try {
                    const response = await fetch(`/status/${currentSessionId}`);
                    const data = await response.json();

                    if (data.error) {
                        clearInterval(statusInterval);
                        alert(data.error);
                        return;
                    }

                    updateStatus(data);

                    if (data.status === 'completed' || data.status === 'error') {
                        clearInterval(statusInterval);
                        if (data.status === 'completed') {
                            showResults(data);
                        } else {
                            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                        }
                    }
                } catch (error) {
                    console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 1000);
        }

        function updateStatus(data) {
            const steps = {
                'transcription': { icon: 'â³', text: 'æ–‡å­—èµ·ã“ã—ä¸­...', completedText: 'âœ… æ–‡å­—èµ·ã“ã—å®Œäº†', elementId: 'statusTranscription' },
                'generating_minutes': { icon: 'â³', text: 'è­°äº‹éŒ²ç”Ÿæˆä¸­...', completedText: 'âœ… è­°äº‹éŒ²ç”Ÿæˆå®Œäº†', elementId: 'statusMinutes' },
                'saving_to_docs': { icon: 'â³', text: 'Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿å­˜ä¸­...', completedText: 'âœ… Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿å­˜å®Œäº†', elementId: 'statusDocs' },
                'sending_slack': { icon: 'â³', text: 'Slacké€šçŸ¥é€ä¿¡ä¸­...', completedText: 'âœ… Slacké€šçŸ¥é€ä¿¡å®Œäº†', elementId: 'statusSlack' },
                'completed': { icon: 'âœ…', text: 'å…¨ã¦å®Œäº†' }
            };

            const stepOrder = ['transcription', 'generating_minutes', 'saving_to_docs', 'sending_slack'];
            const isCompleted = data.status === 'completed';

            if (isCompleted) {
                const allStepIds = ['statusTranscription', 'statusMinutes', 'statusDocs', 'statusSlack'];
                allStepIds.forEach((elementId, index) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        const iconElement = element.querySelector('.status-icon');
                        const textElement = element.querySelector('.status-text');
                        if (iconElement) {
                            iconElement.textContent = 'âœ…';
                        }
                        if (textElement) {
                            const stepKey = stepOrder[index];
                            textElement.textContent = steps[stepKey] ? steps[stepKey].completedText : 'âœ… å®Œäº†';
                        }
                        element.classList.add('completed');
                        element.classList.remove('processing', 'waiting');
                    }
                });
                document.getElementById('progressFill').style.width = '100%';
                const statusSection = document.getElementById('statusSection');
                if (statusSection) {
                    let completedMessage = document.getElementById('completedMessage');
                    if (!completedMessage) {
                        completedMessage = document.createElement('div');
                        completedMessage.id = 'completedMessage';
                        completedMessage.className = 'completed-message';
                        completedMessage.innerHTML = '<h3>ğŸ‰ å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>';
                        statusSection.appendChild(completedMessage);
                    }
                }
                return;
            }

            const currentStep = data.step;
            const currentStepIndex = stepOrder.indexOf(currentStep);

            stepOrder.forEach((step, index) => {
                const stepInfo = steps[step];
                const element = document.getElementById(stepInfo.elementId);
                if (element) {
                    if (index < currentStepIndex) {
                        element.classList.remove('processing', 'waiting');
                        element.classList.add('completed');
                        const iconElement = element.querySelector('.status-icon');
                        const textElement = element.querySelector('.status-text');
                        if (iconElement) iconElement.textContent = 'âœ…';
                        if (textElement) textElement.textContent = stepInfo.completedText;
                    } else if (index === currentStepIndex) {
                        element.classList.remove('waiting', 'completed');
                        element.classList.add('processing');
                        const iconElement = element.querySelector('.status-icon');
                        const textElement = element.querySelector('.status-text');
                        if (iconElement) iconElement.textContent = stepInfo.icon;
                        if (textElement) textElement.textContent = stepInfo.text;
                    } else {
                        element.classList.remove('processing', 'completed');
                        element.classList.add('waiting');
                    }
                }
            });

            const progress = ((currentStepIndex + 1) / stepOrder.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function showResults(data) {
            resultsSection.style.display = 'block';
            updateStatus(data);

            if (data.minutes) {
                const preview = document.getElementById('minutesPreview');
                preview.innerHTML = convertMarkdownToHtml(data.minutes);
            }

            if (data.slack_message) {
                document.getElementById('slackMessage').textContent = data.slack_message;
            }

            if (data.document_url) {
                document.getElementById('docLink').href = data.document_url;
            }

            if (currentSessionId) {
                document.getElementById('downloadLink').href = `/download/${currentSessionId}`;
            }
        }

        function convertMarkdownToHtml(markdown) {
            return markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/\n/gim, '<br>');
        }
    </script>
</body>
</html>

